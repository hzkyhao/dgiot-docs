
== 计量化系统 ==

计量自动化主站系统总体可分为前置机采集层、物理隔离层、计算服务层、应用层
 
前置机采集层包括前置机和定时采集两个模块，前置机主要负责对终端通道的管理及在终端和主站其他模块之间转发各种请求，包括数据召测、参数设置、参数召测、控制命令等；定时采集模块负责定时采集原始数据。

物理隔离层负责将数据采集层和应用层隔开，同时又提供特定的API使用户能够以编程的方式通过正/反向物理隔离装置，为内外网数据交互提供软件通道。

计算服务层负责针对各种采集数据进行统计、分析、计算以提供应用层展现所需要的数据。

数据处理层负责对各种采集、计算数据进行入库以及为其他系统提供所需要的数据，如接口等。

业务应用层负责提供操作本系统的交互界面，方便用户进行日常工作。


****
系统原理
计量自动化系统分为数据采集和数据分析查询应用两部分。前置机和定时采集主要采集原始数据，计算服务对原始数据进行计算、分析。
3.1数据采集原理
数据采集主要涉及到前置机、定时任务、日志服务。
****

=== 术语描述 ===

=== 前置机 ===
 负责通过各种通信介质和终端进行通信的前置设备，并能在主站其他部分脱离联系后（通讯部分还正常），维持系统运行的设备。
 在终端和web通讯服务之间转发数据招测、参数设置/招测、控制等请求与响应;给各定时任务程序分配采集终端;

==== 同终端建立通道 ====
 符合计量自动化终端上行通信规约集中器连接端口:16110; 发送登录报文可与前置机建立连接,通过心跳保持连接.
****
前置机判断终端在线条件:前置机收到每个终端的每条上行报文时，立即为每个终端记录下最新接收数据的时间。
1.GPRS/CDMA通道（负控/配变/电能量终端）的终端在线条件：a.终端与前置机通道连接正常，b. 2个心跳周期（30分钟）内终端有上行报文；以上两个条件同时满足则认为终端在线，否则不在线；
2.TCPClient网络/电话/串口通道的终端在线条件：a.前置机向终端连接成功,b.1小时内终端有上行报文；以上两个条件只要满足一个则认为终端在线，否则不在线。
****



==== 资产管理 ====
实现对表具的基础档案管理，支持对基础档案的删除、修改和新增等功能。
电表：名称、表地址、CT、PT、表号、条码、生产日期、校表日期、表精度、满码字、表型号等信息、生产厂商、规格型号、厂编号等信息；

link:paths.adoc[档案查询api]

link:paths.adoc[档案新增api]

link:paths.adoc[档案删除api]


==== 终端通道参数 ====
可对通道进行新增、修改、删除等操作。可维护的内容包括通道名称、端口地址、代码、初始化串等，通道类型、端口类型、波特率、数据位、停止位、校验位等.

link:paths.adoc[终端通道查询api]

link:paths.adoc[终端通道新增/修改api]

link:paths.adoc[终端通道删除api]

==== 终端搜表 ====
测量点设备可以自动入网注册,也可以通过终端主动搜索

link:paths.adoc[搜表api]


==== 校时 ====
可对终端的时间与主站时间同步,可查看终端时间,可对下挂的表具进行广播校时.

link:paths.adoc[校时api]

link:paths.adoc[广播校时api]

==== 测量点参数====
通过终端对测量点新增、修改、删除等操作。可维护的内容包括状态,性质,地址,通信规约,测量点类型,总分类型,重点用户属性,是否带有拉合闸功能,最大费率数,采集终端地址,测量点端口号,端口参数,波特率,校验方式,数据位,停止位,PT变化,CT变化.

link:paths.adoc[测量点新增api]

link:paths.adoc[测量点修改api]

link:paths.adoc[测量点删除api]

==== 测量点拉/合闸 ====
通过终端对表具进行拉合闸控制

link:paths.adoc[拉闸api]

link:paths.adoc[合闸api]

==== 测量点波特率修改 ====
通过终端对表具进行波特率修改

link:paths.adoc[测量点波特率修改api]


==== 测量点召测实时数据 ====
召测测量点电量示度，变量,参变量,瞬时量，需量等,以及终端持有参数

link:paths.adoc[测量点当前数据api]

link:paths.adoc[终端持有参数api]

==== 测量点召测日数据 ====
查询日累计测量点电量总量,可查找连续多日的日数据列表
link:paths.adoc[日数据api]

==== 测量点召读月数据 ====
查询月累计测量点电量总量,可查找连续多月的月数据列表

link:paths.adoc[日数据api]

==== 测量点召读曲线数据 ====
曲线数据是按照一定周期对测量点多次采集得到的数据曲线
link:paths.adoc[曲线数据api]

==== 测量点召读告警数据 ====
对抄表数据监测：时钟异常,电压错误、电流错误、电量示度错误、继电器变位,拉合闸失败,时段费率改变,月流量超出,余额不足等状况,每天只存一条记录。
开启告警判断屏蔽字，终端启动对应的告警判断，若告警数据可以主动上送，需开启告警主动上送的屏蔽字

link:paths.adoc[查询告警屏蔽字api]

link:paths.adoc[修改告警屏蔽字api]

link:paths.adoc[查询告警主动上报屏蔽字api]

link:paths.adoc[修改告警主动上报屏蔽字api]

link:paths.adoc[查询告警字api]

==== 控制事件 ====
对表控制事件进行记录,每天只存一条记录。
开启事件判断屏蔽字，终端启动对应的事件记录，可通过查询获得
link:paths.adoc[查询事件屏蔽字api]

link:paths.adoc[修改事件屏蔽字api]

link:paths.adoc[查询控制事件api]

==== 中继转发 ====
将主站指令直接透传给测量点,指令需要遵守测量适用的通信规约.

link:paths.adoc[中继转发api]

=== 中继任务 ====
周期性地将主站指令直接透传给测量点,指令需要遵守测量适用的通信规约.

link:paths.adoc[中继任务api]

=== 普通任务 ====
周期性对批量测量点进行数据采集,并周期性上报
link:paths.adoc[普通任务api]

== 计算服务 ==
1)管理,统计工作设备(集中器,采集模块,终端设备)
2)计量点各费率电量计算；
3)对采集任务进行统计,计算;
4)支持不同规约;
5)设置采集方案的数据内容、采集周期、采集滑动周期、启动时间等。
6)为工作站程序和WEB程序提供远程计算功能调用。


==== 节点监视 ====
实时显示采集服务器、通信设备以及终端设备的运行状态，在线率.

==== 集中器设备 ====
集中器配置管理,运行状况,连接状态,下挂设备情况,可新增,修改,删除,开关运行,断连链接.
link:paths.adoc[查询集中器设备api]

link:paths.adoc[新增集中器api]

link:paths.adoc[修改集中器api]

link:paths.adoc[删除集中器api]

link:paths.adoc[运行/关闭集中器api]

link:paths.adoc[启动连接api]


==== 通信设备 ====
通信设备配置管理,运行状况,连接状态,下挂设备情况,可新增,修改,删除,可启动搜表.
link:paths.adoc[查询通信设备api]

link:paths.adoc[新增通信设备api]

link:paths.adoc[修改通信设备api]

link:paths.adoc[删除通信设备api]

link:paths.adoc[搜表api]

==== 终端设备 ====
终端设备配置管理,运行状况,在线率.

link:paths.adoc[查询终端设备配置api]

link:paths.adoc[查询终端设备在线率api]




==== 采集任务管理 ====
=== 集中器 ===
==== 并行抄读 ====
1)同时抄读多个终端，在通道允许的情况下，数据采集软件可同时抄读多个终端。
2)多通道，多种通信方式同时工作。
3)支持手工召读群组并行工作
通信方式，光纤、无线、GPRS，小无线，lora。
系统支持多采集服务器负载均衡、多线程并发的通信调度管理机制。。
==== 实时数据库服务 ====

=== 定时采集 ===

定时采集可将一些高频采集的数据,及时的,有策略的,高效地采集,并统一进行管理,分析,统计,存库,上报.
****
采集任务执行流程:

1).定时任务模块根据各集中器配置的采集模板定时生成任务；

2).找到各终端对应影子设备,然后找出对应的通信设备;

3).通信设备接收到定时任务发送过来的各种请求后,根据各任务所包含的信息组织各任务对应终端协议的请求命令报文;

4).终端接收到报文后,可通过终端地址,找到对应的影子设备将数据返回,由影子设备将数据解析完转回任务模块;

5).任务模块对采集到的数据进行存库,上报,统计;

6).主站也可以对数据进行主动召读.

任务生成策略:

任务可分为实时数据任务和冻结数据任务,所谓实时数据任务就是指采集的数据是实时数据，冻结数据任务指采集的数据是事先在终端内已经冻结好的数据。
针对实时数据任务，定时任务按照一定的周期（即实时数据模板配置的采集周期）从任务列表查找满足采集周期条件的任务，找到的任务即为需要执行的任务，任务的执行时间为任务生成时间。没有抄成功的数据将会进行多次自动补抄.

对于实时数据任务，由于网络等太多的不确定性导致漏点的数据无法再次采集，故在本系统中一般重要数据的采集任务均配置成冻结数据任务，由于冻结数据任务会在终端内保存一定的时间，所以只要记录下每次采集数据的时标，而在下次采集时接着上次采集的时标继续采集就能最大程度的保证数据采集的完整性。

定时任务发送采集请求后，终端应答分三种情况：不应答、正常应答、错误应答。
对于不是正常应答的均属于采集失败,将放于下一轮自动补抄队列中.
新一周期任务开始后,在任务的空闲期间,也会对前几周期未采集成功的终端进行自动补抄,以尽可能提高采集成功率.如果多次失败,将进行人工排查终端设备.
****
==== 任务模板配置 ====
 可将任务开始时间,周期频率,数据项,集中器,冻结时间,下发通道内容配置到模板中,任务启动后将对该集中器下的终端进行采集数据.冻结数据可通过配置,在一天内进行多次补采.

link:paths.adoc[任务模板配置api]



==== 查询任务列表 ====
 提供已下发任务详情,包括集中器地址,下挂的终端,采集数据项,下发通道,成功率等具体内容的查询.

link:paths.adoc[查询任务列表api]

==== 任务抄表结果统计 ====
 对集中器下挂终端的某项数据的某一天的采集成功率统计,以及每个终端的抄表情况.

link:paths.adoc[抄表结果统计api]

==== 手工补采数据 ====
 对没有抄成功的终端通过手动补采的形式获得数据

link:paths.adoc[立即补抄api]

==== 任务抄表数据查询 ====
 采用本地数据库缓存的方法保证在中心数据库不可用的情况下采集数据仍然不丢失,用户可查询某个终端,某项数据的采集结果.

link:paths.adoc[抄表数据查询api]


==== 上报主站统计 ====
 采集的冻结数据,将会按照协议实时上报主站,并存于本地数据库,并做统计,对于没有上报成功的数据将在本日内进行重报

link:paths.adoc[上报主站统计api]


=== 日志服务 ===
==== 前置机和定时任务的通讯日志 ====
==== 前置机发送的上行/下行报文 ====
对报文进行分析，统计出终端工况数据（上/下行流量、终端在线时间、离线时间、是否含有有效数据等），每日0:10分存库。

=== 测试台体 ===
==== 历史日数据 ====

集中器将采集的数据在日末（次日零点）形成各种历史日数据，要求保存每个电能表最近31天日数据，历史日采集数据内容见表3。
  
表3　历史日数据
                                             
|===
|序号|	数据项  |数据源	||	
|	 |	         |集中器	|单相表	|多功能表
|1	|日正向有功电能示值（总、各费率）	| 	|√	|√
|2	|日正向无功电能示值（总、各费率）	| 	| 	|√
|3	|日反向有功电能示值（总、各费率）	| 	|√	|√
|4	|日反向无功电能示值（总、各费率）	| 	| 	|√
|5	|日一～四象限无功电能示值	 	 	|√  |   |
|6	|电能表状态字	                	|√	|√  |
|7	|终端与主站日通信流量           	|√	| 	|
|===

==== 历史月数据 ====

集中器将采集的数据在月末零点（每月1日零点）生成各种历史月数据，要求保存最近12个月的月数据，历史月采集数据内容见 表9。

表9　历史月数据

|===
|序号|	数据项  |数据源	||			
|	 |	         |集中器	|单相表	|多功能表	
|1	|月正向有功电能示值（总、各费率）	| 	|√	|√
|2	|月正向无功电能示值（总、各费率）	| 	| 	|√
|3	|月反向有功电能示值（总、各费率）	| 	|√	|√
|4	|月反向无功电能示值（总、各费率）	| 	| 	|√
|5	|月一～四象限无功电能示值	 	 	|  
|   |√ 
|6	|月有功最大需量及发生时间        	| 	|   |√
|7	|终端与主站月通信流量           	|√	| 	|
|8	|月电压越限统计数据                 |√	|	|
|===




=== 功能授权 ===
==== 可定制页面功能授权 ====
1.以系统管理员身份对部门管理员进行页面功能（参数设置、错峰管理等）配置；

2.以部门管理员身份对操作员进行页面功能（参数设置、错峰管理等）配置。

==== 操作功能授权 ====

1.以系统管理员身份对部门管理员进行操作功能（如：参数维护的增、删、改、数据录入、换表/换CT/换PT等）授权；

2.以部门管理员身份对操作员进行操作功能（如：参数维护的增、删、改、数据录入、换表/换CT/换PT等）授权。

